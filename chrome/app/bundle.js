(()=>{"use strict";var t={};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}();var e=function(t,e,n,i){return new(n||(n=Promise))((function(r,a){function s(t){try{l(i.next(t))}catch(t){a(t)}}function o(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,o)}l((i=i.apply(t,e||[])).next())}))},n=function(t,e,n,i){return new(n||(n=Promise))((function(r,a){function s(t){try{l(i.next(t))}catch(t){a(t)}}function o(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,o)}l((i=i.apply(t,e||[])).next())}))};var i;(i=t.g).LogPrint=t=>{console.log("[Purple]: ",t)},i.isAds=t=>t.toString().includes("stitched-ad")||t.toString().includes("twitch-client-ad")||t.toString().includes("twitch-ad-quartile"),i.realFetch=fetch,i.isProxyAuth=!1,i.quality="",i.whitelist=[],t.g.whitelist=[],i.addEventListener("message",(function(t){switch("setQuality"===t.data.funcName&&(i.quality=t.data.args[0].name),t.data.type){case"setSetting":t.data.value&&(i.whitelist=t.data.value.whiteList,i.isProxyAuth=t.data.value.toggleProxy);break;case"setQuality":i.quality=t.data.value.name}})),i.postMessage({type:"init",value:null}),i.comingAds=!1,i.channel=[],i.actualChannel="",i.currentChannel=function(e=null){return e?t.g.channel.find((t=>t.name===e)):t.g.channel.find((e=>e.name===t.g.actualChannel))},i.newPicture=function(e){return n=this,i=void 0,a=function*(){try{const n=yield t.g.realFetch("https://gql.twitch.tv/gql",{method:"POST",headers:{"Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko"},body:`{"operationName":"PlaybackAccessToken","variables":{"isLive":true,"login":"${e}","isVod":false,"vodID":"","playerType":"thunderdome"},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"0828119ded1c13477966434e15800ff57ddacf13ba1911c129dc2200705b0712"}}}`}),i=yield n.json(),r="https://usher.ttvnw.net/api/channel/hls/"+e+".m3u8?allow_source=true&fast_bread=true&p="+Math.floor(1e7*Math.random())+"&player_backend=mediaplayer&playlist_include_framerate=true&reassignments_supported=false&sig="+i.data.streamPlaybackAccessToken.signature+"&supported_codecs=avc1&token="+i.data.streamPlaybackAccessToken.value;return yield(yield t.g.realFetch(r)).text()}catch(t){console.log(t)}},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{l(a.next(t))}catch(t){e(t)}}function o(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,o)}l((a=a.apply(n,i||[])).next())}));var n,i,r,a},i.newExternal=function(e){return n=this,i=void 0,a=function*(){try{t.g.LogPrint("External Server: Loading");const n=yield t.g.realFetch("https://"+t.g.tunnel[0]+"/channel/"+e);if(!n.ok)throw new Error("server proxy return error or not found");const i=yield n.text();return t.g.LogPrint("External Server: OK"),i}catch(e){return t.g.LogPrint(e),""}},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{l(a.next(t))}catch(t){e(t)}}function o(t){try{l(a.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,o)}l((a=a.apply(n,i||[])).next())}));var n,i,r,a},i.tunnel=["eu1.jupter.ga"],i.onFetch=function(e,n,i){return r=this,a=void 0,o=function*(){const e=yield t.g.currentChannel();if(!t.g.isAds(n))return e.hls.addPlaylist(n),!0;{t.g.LogPrint("ads found"),e.hls.addPlaylist(n),t.g.postMessage({type:"getQuality",value:null}),t.g.postMessage({type:"reload",value:null});const r=t.g.quality,a=e.hls.StreamServerList;t.g.LogPrint(r);try{if(a.length>0){const n=a.find((t=>"proxy"==t.server));if(!n)throw new Error("No m3u8 valid url found on StreamServerList");const s=n.urlList.find((t=>t.quality==r));if(!s)throw new Error("No m3u8 valid url found on StreamServerList");const o=yield t.g.realFetch(s.url);var i=yield o.text();if(t.g.isAds(i))throw t.g.LogPrint("ads on proxy"),new Error("No m3u8 valid url found on StreamServerList");return e.hls.addPlaylist(i)}throw new Error("No m3u8 valid url found on StreamServerList")}catch(n){const i=a.filter((t=>"picture"==t.server)).map((t=>t.urlList.find((t=>t.quality.includes("480")))))[0].url,r=yield(yield t.g.realFetch(i)).text();return e.hls.addPlaylist(r)&&t.g.LogPrint("480p"),!0}}},new((s=void 0)||(s=Promise))((function(t,e){function n(t){try{l(o.next(t))}catch(t){e(t)}}function i(t){try{l(o.throw(t))}catch(t){e(t)}}function l(e){var r;e.done?t(e.value):(r=e.value,r instanceof s?r:new s((function(t){t(r)}))).then(n,i)}l((o=o.apply(r,a||[])).next())}));var r,a,s,o},i.onStartChannel=function(e,n,i){return r=this,a=void 0,o=function*(){const r=/hls\/(.*).m3u8/gm.exec(n)||[];let a=!1;if(r[1]){if(null==t.g.whitelist&&(t.g.whitelist=[]),t.g.actualChannel=r[1],t.g.whitelist.includes(r[1]))return;e.channel.find((t=>t.name===r[1]))?(e.LogPrint("Exist: "+r[1]),a=!0):(e.LogPrint("Channel: "+r[1]),e.channel.push({name:r[1],flowSig:[],hls:new e.HLS}))}e.LogPrint("Local Server: Loading"),t.g.currentChannel(r[1]).hls.addStreamLink(i),e.LogPrint("Local Server: OK"),a||(yield t.g.newPicture(t.g.actualChannel).then((e=>{t.g.currentChannel(r[1]).hls.addStreamLink(e,"picture",!0),t.g.LogPrint("Local Server 480p: OK")})),t.g.isProxyAuth&&t.g.newExternal(t.g.actualChannel).then((e=>t.g.currentChannel(r[1]).hls.addStreamLink(e,"proxy",!0))))},new((s=void 0)||(s=Promise))((function(t,e){function n(t){try{l(o.next(t))}catch(t){e(t)}}function i(t){try{l(o.throw(t))}catch(t){e(t)}}function l(e){var r;e.done?t(e.value):(r=e.value,r instanceof s?r:new s((function(t){t(r)}))).then(n,i)}l((o=o.apply(r,a||[])).next())}));var r,a,s,o},i.HLS=class{constructor(){this._header=["#EXTM3U","#EXT-X-VERSION:3","#EXT-X-TARGETDURATION:6","#EXT-X-MEDIA-SEQUENCE:"],this._playlist=[],this._sequence=0,this._streamServerList=[]}addStreamLink(t,e="local",i=!1){return n(this,void 0,void 0,(function*(){const n=[];let r;const a=/NAME="((?:\S+\s+\S+|\S+))",AUTO(?:^|\S+\s+)(?:^|\S+\s+)(https:\/\/video(\S+).m3u8)/g;for(;null!==(r=a.exec(t));)n.push({quality:r[1],url:r[2]});console.log(n);const s={server:e,urlList:n,sig:i};return this._streamServerList.push(s),i||(yield this.signature()),!0}))}signature(){return n(this,void 0,void 0,(function*(){const t=/video-weaver.(.*).hls.ttvnw.net\/v1\/playlist\/(.*).m3u8$/gm;yield new Promise((e=>this._streamServerList.filter((t=>0==t.sig)).forEach((i=>n(this,void 0,void 0,(function*(){const n=t.exec(i.urlList[0].url);if(n)try{yield fetch("https://jupter.ga/hls/v2/sig/"+n[2]+"/"+n[1],{method:"GET"}),i.sig=!0,e(!0)}catch(t){e(!1)}else e(!1)}))))))}))}get StreamServerList(){return this._streamServerList}addPlaylist(t){if(null===t)return!1;let e=!1;const n=t.toString().split(/[\r\n]/);this._header[4]=n[4],this._header[5]=n[5];for(const t in n)if(n[t].includes("#EXTINF")&&n[t].includes(",live")){const i=Math.floor(new Date(n[parseInt(t)-1].slice(n[parseInt(t)-1].length-24,n[parseInt(t)-1].length)).getTime()/1e3);for(this._playlist.filter((t=>t.timestamp>=i)).length||(this._sequence=this._sequence+1,this._playlist.push({time:n[parseInt(t)-1],timestamp:i,info:n[parseInt(t)],url:n[parseInt(t)+1]}),e=!0);this._playlist.length>15;)this._playlist.shift()}return e}getAllPlaylist(){return this._header[0]+"\n"+this._header[1]+"\n"+this._header[2]+"\n"+this._header[3]+this._sequence+"\n"+this._header[4]+"\n"+this._header[5]+"\n"+this._playlist.map((t=>t.time+"\n"+t.info+"\n"+t.url+"\n"))}},t.g.fetch=function(n,i){return e(this,arguments,void 0,(function*(){if("string"==typeof n){if(n.endsWith("m3u8")&&n.includes("ttvnw.net")&&!t.g.whitelist.includes(t.g.actualChannel))return new Promise((function(r,a){!function(n){e(this,void 0,void 0,(function*(){try{yield t.g.realFetch(n,i).then((function(e){e.text().then((function(e){t.g.onFetch(t.g,e,n).then((function(e){var n=t.g.currentChannel().hls.getAllPlaylist();r(new Response(n))}))}))}))}catch(t){r(new Response)}}))}(n)}));if(n.includes("usher.ttvnw.net/api/channel/hls/")&&!n.includes("picture-by-picture"))return new Promise((function(r,a){!function(n){e(this,void 0,void 0,(function*(){yield t.g.realFetch(n,i).then((function(i){i.ok?i.text().then((function(i){return e(this,void 0,void 0,(function*(){yield t.g.onStartChannel(t.g,n,i),r(new Response(i))}))})):(r(i),t.g.LogPrint("channel offline"))}))}))}(n)}));n.includes("picture-by-picture")}return t.g.realFetch.apply(this,arguments)}))}})();