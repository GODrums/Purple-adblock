(()=>{"use strict";!function(){let t;window.postMessage({type:"init"}),window.Worker=class extends Worker{constructor(e){console.log("new worker intance "+e),""==e&&super(e),console.log("[Purple]: init "+e);const s=`(()=>{"use strict";var t={};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}();class e{constructor(){this._header=["#EXTM3U","#EXT-X-VERSION:3","#EXT-X-TARGETDURATION:6","#EXT-X-MEDIA-SEQUENCE:"],this._playlist=[],this._sequence=0}addPlaylistTest(t){}addPlaylist(t){if(null===t)return!1;let e=!1;const i=t.toString().split(/[\\r\\n]/);this._header[4]=i[4],this._header[5]=i[5];for(const t in i)if(i[t].includes("#EXTINF")&&i[t].includes(",live")){const s=Math.floor(new Date(i[parseInt(t)-1].slice(i[parseInt(t)-1].length-24,i[parseInt(t)-1].length)).getTime()/1e3);for(this._playlist.filter((t=>t.timestamp>=s)).length||(this._sequence=this._sequence+1,this._playlist.push({time:i[parseInt(t)-1],timestamp:s,info:i[parseInt(t)],url:i[parseInt(t)+1]}),e=!0);this._playlist.length>15;)this._playlist.shift()}return e}getPlaylist(){return this._header[0]+"\\n"+this._header[1]+"\\n"+this._header[2]+"\\n"+this._header[3]+this._sequence+"\\n"+this._header[4]+"\\n"+this._header[5]+"\\n"+this._playlist.map((t=>t.time+"\\n"+t.info+"\\n"+t.url+"\\n"))}}class i{constructor(t){this.bestQuality=()=>this.urlList[0],this.findByQuality=t=>this.urlList.find((e=>e.quality==t)),Object.assign(this,t)}}var s=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{h(s.next(t))}catch(t){r(t)}}function l(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,l)}h((s=s.apply(t,e||[])).next())}))};class n{constructor(t){this.serverList=[],this.hls=new e,this.channelName="",this.tunnel=["eu1.jupter.ga"],this.channelName=t}addStreamLink(t,e="local",n=!1){return s(this,void 0,void 0,(function*(){const s=[];let r;const a=/NAME="((?:\\S+\\s+\\S+|\\S+))",AUTO(?:^|\\S+\\s+)(?:^|\\S+\\s+)(https:\\/\\/video(\\S+).m3u8)/g;for(;null!==(r=a.exec(t));)s.push({quality:r[1],url:r[2]});console.log(s);const l=new i({type:e,urlList:s,sig:n});return this.serverList.push(l),n||(yield this.signature()),!0}))}signature(){return s(this,void 0,void 0,(function*(){const t=/video-weaver.(.*).hls.ttvnw.net\\/v1\\/playlist\\/(.*).m3u8$/gm;yield new Promise((e=>this.serverList.filter((t=>0==t.sig)).forEach((i=>s(this,void 0,void 0,(function*(){const s=t.exec(i.urlList[0].url);if(s)try{yield fetch("https://jupter.ga/hls/v2/sig/"+s[2]+"/"+s[1]),i.sig=!0,e(!0)}catch(t){e(!1)}else e(!1)}))))))}))}externalPlayer(){return s(this,void 0,void 0,(function*(){try{t.g.LogPrint("External Server: Loading");const e=yield t.g.realFetch("https://"+this.tunnel[0]+"/channel/"+this.channelName);if(!e.ok)throw new Error("server proxy return error or not found");const i=yield e.text();return t.g.LogPrint("External Server: OK"),this.addStreamLink(i),!0}catch(e){return t.g.LogPrint(e),!1}}))}streamAccess(e){return s(this,void 0,void 0,(function*(){try{const i=yield t.g.realFetch("https://gql.twitch.tv/gql",{method:"POST",headers:{"Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko"},body:\`{"operationName":"PlaybackAccessToken","variables":{"isLive":true,"login":"\${this.channelName}","isVod":false,"vodID":"","playerType":"\${e.playerType}"},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"0828119ded1c13477966434e15800ff57ddacf13ba1911c129dc2200705b0712"}}}\`}),s=yield i.json(),n="https://usher.ttvnw.net/api/channel/hls/"+this.channelName+".m3u8?allow_source=true&fast_bread=true&p="+Math.floor(1e7*Math.random())+"&player_backend=mediaplayer&playlist_include_framerate=true&reassignments_supported=false&sig="+s.data.streamPlaybackAccessToken.signature+"&supported_codecs=avc1&token="+s.data.streamPlaybackAccessToken.value,r=yield(yield t.g.realFetch(n)).text();return t.g.LogPrint("Server loaded "+e.name),this.addStreamLink(r,e.name),!0}catch(t){return console.log(t),!1}}))}}const r={playerType:"thunderdome",name:"lower"},a={playerType:"site",name:"normal"},l="external";class h{constructor(){this.getQuality=()=>t.g.postMessage({type:"getQuality"}),this.init=()=>t.g.postMessage({type:"init"}),this.pause=()=>t.g.postMessage({type:"pause"}),this.play=()=>t.g.postMessage({type:"play"}),this.pauseAndPlay=()=>{this.pause,this.play},this.quality="",this.setting={},t.g.onEventMessage=t=>{switch(t.data.funcName){case"setSinkType":default:break;case"setQuality":t.data.args&&(this.quality=t.data.args[0].name),t.data.value&&(this.quality=t.data.value);break;case"setSetting":console.log(t.data.value),this.setting=t.data.value}}}}var o=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{h(s.next(t))}catch(t){r(t)}}function l(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,l)}h((s=s.apply(t,e||[])).next())}))};class c{constructor(){this.whitelist=[],this.isProxyAuth=!1,this.streamList=[],this.actualChannel="",this.playingAds=!1,this.quality="",this.LogPrint=t.g.LogPrint,this.message=new h,this.endAds=()=>this.message.pauseAndPlay(),this.isAds=t=>{const e=t.toString().includes("stitched-ad")||t.toString().includes("twitch-client-ad")||t.toString().includes("twitch-ad-quartile");return this.playingAds!=e&&this.endAds(),this.playingAds=e,this.playingAds},this.currentStream=(t=this.actualChannel)=>this.streamList.find((e=>e.channelName===t)),this.message.init()}onfetch(t,e){return o(this,void 0,void 0,(function*(){const t=yield this.currentStream();if(t.hls.addPlaylist(e),console.log(this.message.quality),!this.isAds(e))return!0;this.LogPrint("ads found"),t.streamAccess(a);try{const e=yield this.fetchm3u8ByStreamType(a.name);if(e&&t.hls.addPlaylist(e),e)return!0;const i=yield this.fetchm3u8ByStreamType(r.name);if(i&&t.hls.addPlaylist(i),i)return!0;const s=yield this.fetchm3u8ByStreamType(l);if(s&&t.hls.addPlaylist(s),s)return!0}catch(t){console.log(t.message)}}))}fetchm3u8ByStreamType(e){return o(this,void 0,void 0,(function*(){this.LogPrint("Stream Type: "+e);const i=this.currentStream().serverList.filter((t=>t.type==e));if(!i)return"";var s=i.map((t=>t.findByQuality(this.message.quality))).filter((t=>void 0!==t));s.length||(s=i.map((t=>t.bestQuality())));for(const e of s){const i=yield(yield t.g.realFetch(null==e?void 0:e.url)).text();if(!this.isAds(i))return i}return""}))}onStartChannel(t,e){return o(this,void 0,void 0,(function*(){const i=/hls\\/(.*).m3u8/gm.exec(t)||[];let s,l=!1;if(i[1]){if(null==this.whitelist&&(this.whitelist=[]),this.actualChannel=i[1],this.LogPrint("Channel "+i[1]),this.whitelist.includes(i[1]))return;this.streamList.find((t=>t.channelName===i[1]))?(this.LogPrint("Exist: "+i[1]),l=!0):this.streamList.push(new n(i[1]))}s=this.currentStream(),this.LogPrint("Local Server: Loading"),yield s.addStreamLink(e,"local"),this.LogPrint("Local Server: OK"),yield s.streamAccess(r),s.streamAccess(a),l||s.externalPlayer()}))}inflateFetch(){t.g.fetch=function(e,i){return o(this,arguments,void 0,(function*(){if("string"==typeof e){if(e.endsWith("m3u8")&&e.includes("ttvnw.net"))return new Promise(((s,n)=>o(this,void 0,void 0,(function*(){try{yield t.g.realFetch(e,i).then((t=>o(this,void 0,void 0,(function*(){return t.text()})))).then((i=>o(this,void 0,void 0,(function*(){yield t.g.player.onfetch(e,i);var n=t.g.player.currentStream().hls.getPlaylist();s(new Response(n))}))))}catch(t){s(new Response)}}))));if(e.includes("usher.ttvnw.net/api/channel/hls/")&&!e.includes("picture-by-picture"))return new Promise(((s,n)=>o(this,void 0,void 0,(function*(){try{const n=yield t.g.realFetch(e,i);n.ok||s(n),n.text().then((i=>o(this,void 0,void 0,(function*(){yield t.g.player.onStartChannel(e,i),s(new Response(i))}))))}catch(t){s(new Response)}}))));e.includes("picture-by-picture")&&this.LogPrint("picture-by-picture")}return t.g.realFetch.apply(this,arguments)}))}}}!function(){t.g.LogPrint=t=>console.log("[Purple]: ",t),t.g.addEventListener("message",(e=>{t.g.onEventMessage(e)}));const e=new c;t.g.realFetch=t.g.fetch,t.g.player=e,e.inflateFetch(),t.g.LogPrint("Script running")}()})();\n      importScripts('${e}');`;super(URL.createObjectURL(new Blob([s],{type:"text/javascript"}))),t=this,t.declareEventWorker(),t.declareEventWindow()}declareEventWorker(){this.addEventListener("message",(e=>{switch(e.data.type){case"init":window.postMessage({type:"getSetting",value:null});break;case"PlayerQualityChanged":console.log("Changed quality by player: "+e.data.arg.name),t.postMessage({funcName:"setQuality",value:e.data.arg.name});break;case"pause":t.postMessage({funcName:"pause",args:void 0,id:1})}}))}declareEventWindow(){window.addEventListener("message",(e=>{"setSetting"===e.data.type&&t.postMessage({funcName:"setSetting",value:e.data.value})}))}}}()})();