(()=>{"use strict";var t,e,n={};n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}();(t=self).LogPrint=t=>{console.log("[Purple]: ",t)},t.isAds=t=>t.toString().includes("stitched-ad")||t.toString().includes("twitch-client-ad")||t.toString().includes("twitch-ad-quartile"),t.realFetch=fetch,t.isProxyAuth=!1,t.quality="",t.whitelist=[],n.g.whitelist=[],t.addEventListener("message",(function(e){switch("setQuality"===e.data.funcName&&(t.quality=e.data.args[0].name),e.data.type){case"setSetting":e.data.value&&(t.whitelist=e.data.value.whiteList,t.isProxyAuth=e.data.value.toggleProxy);break;case"setQuality":t.quality=e.data.value.name}})),t.postMessage({type:"init",value:null}),t.comingAds=!1,t.channel=[],t.actualChannel="",t.currentChannel=function(t=null){return t?n.g.channel.find((e=>e.name===t)):n.g.channel.find((t=>t.name===n.g.actualChannel))},t.newPicture=async function(t){try{const e=await n.g.realFetch("https://gql.twitch.tv/gql",{method:"POST",headers:{"Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko"},body:`{"operationName":"PlaybackAccessToken","variables":{"isLive":true,"login":"${t}","isVod":false,"vodID":"","playerType":"thunderdome"},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"0828119ded1c13477966434e15800ff57ddacf13ba1911c129dc2200705b0712"}}}`}),a=await e.json(),r="https://usher.ttvnw.net/api/channel/hls/"+t+".m3u8?allow_source=true&fast_bread=true&p="+Math.floor(1e7*Math.random())+"&player_backend=mediaplayer&playlist_include_framerate=true&reassignments_supported=false&sig="+a.data.streamPlaybackAccessToken.signature+"&supported_codecs=avc1&token="+a.data.streamPlaybackAccessToken.value;return await(await n.g.realFetch(r)).text()}catch(t){console.log(t)}},t.newExternal=async function(t){try{n.g.LogPrint("External Server: Loading");const e=await n.g.realFetch("https://"+n.g.tunnel[0]+"/channel/"+t);if(!e.ok)throw new Error("server proxy return error or not found");const a=await e.text();return n.g.LogPrint("External Server: OK"),a}catch(t){return n.g.LogPrint(t),""}},t.tunnel=["eu1.jupter.ga"],t.onFetch=async function(t,e,a){const r=await n.g.currentChannel();if(!n.g.isAds(e))return r.hls.addPlaylist(e),!0;{n.g.LogPrint("ads found"),r.hls.addPlaylist(e),n.g.postMessage({type:"getQuality",value:null}),n.g.postMessage({type:"reload",value:null});const t=n.g.quality,a=r.hls.StreamServerList;n.g.LogPrint(t);try{if(a.length>0){const e=a.find((t=>"proxy"==t.server));if(!e)throw new Error("No m3u8 valid url found on StreamServerList");const s=e.urlList.find((e=>e.quality==t));if(!s)throw new Error("No m3u8 valid url found on StreamServerList");const l=await n.g.realFetch(s.url);var i=await l.text();if(n.g.isAds(i))throw n.g.LogPrint("ads on proxy"),new Error("No m3u8 valid url found on StreamServerList");return r.hls.addPlaylist(i)}throw new Error("No m3u8 valid url found on StreamServerList")}catch(t){const e=a.filter((t=>"picture"==t.server)).map((t=>t.urlList.find((t=>t.quality.includes("480")))))[0].url,i=await(await n.g.realFetch(e)).text();return r.hls.addPlaylist(i)&&n.g.LogPrint("480p"),!0}}},t.onStartChannel=async function(t,e,a){const r=/hls\/(.*).m3u8/gm.exec(e)||[];let i=!1;if(r[1]){if(null==n.g.whitelist&&(n.g.whitelist=[]),n.g.actualChannel=r[1],n.g.whitelist.includes(r[1]))return;t.channel.find((t=>t.name===r[1]))?(t.LogPrint("Exist: "+r[1]),i=!0):(t.LogPrint("Channel: "+r[1]),t.channel.push({name:r[1],flowSig:[],hls:new t.HLS}))}t.LogPrint("Local Server: Loading"),n.g.currentChannel(r[1]).hls.addStreamLink(a),t.LogPrint("Local Server: OK"),i||(await n.g.newPicture(n.g.actualChannel).then((t=>{n.g.currentChannel(r[1]).hls.addStreamLink(t,"picture",!0),n.g.LogPrint("Local Server 480p: OK")})),n.g.isProxyAuth&&n.g.newExternal(n.g.actualChannel).then((t=>n.g.currentChannel(r[1]).hls.addStreamLink(t,"proxy",!0))))},t.HLS=class{constructor(){this._header=["#EXTM3U","#EXT-X-VERSION:3","#EXT-X-TARGETDURATION:6","#EXT-X-MEDIA-SEQUENCE:"],this._playlist=[],this._sequence=0,this._streamServerList=[]}async addStreamLink(t,e="local",n=!1){const a=[];let r;const i=/NAME="((?:\S+\s+\S+|\S+))",AUTO(?:^|\S+\s+)(?:^|\S+\s+)(https:\/\/video(\S+).m3u8)/g;for(;null!==(r=i.exec(t));)a.push({quality:r[1],url:r[2]});console.log(a);const s={server:e,urlList:a,sig:n};return this._streamServerList.push(s),n||await this.signature(),!0}async signature(){const t=/video-weaver.(.*).hls.ttvnw.net\/v1\/playlist\/(.*).m3u8$/gm;await new Promise((e=>this._streamServerList.filter((t=>0==t.sig)).forEach((async n=>{const a=t.exec(n.urlList[0].url);if(a)try{await fetch("https://jupter.ga/hls/v2/sig/"+a[2]+"/"+a[1],{method:"GET"}),n.sig=!0,e(!0)}catch{e(!1)}else e(!1)}))))}get StreamServerList(){return this._streamServerList}addPlaylist(t){if(null===t)return!1;let e=!1;const n=t.toString().split(/[\r\n]/);this._header[4]=n[4],this._header[5]=n[5];for(const t in n)if(n[t].includes("#EXTINF")&&n[t].includes(",live")){const a=Math.floor(new Date(n[parseInt(t)-1].slice(n[parseInt(t)-1].length-24,n[parseInt(t)-1].length)).getTime()/1e3);for(this._playlist.filter((t=>t.timestamp>=a)).length||(this._sequence=this._sequence+1,this._playlist.push({time:n[parseInt(t)-1],timestamp:a,info:n[parseInt(t)],url:n[parseInt(t)+1]}),e=!0);this._playlist.length>15;)this._playlist.shift()}return e}getAllPlaylist(){return this._header[0]+"\n"+this._header[1]+"\n"+this._header[2]+"\n"+this._header[3]+this._sequence+"\n"+this._header[4]+"\n"+this._header[5]+"\n"+this._playlist.map((t=>t.time+"\n"+t.info+"\n"+t.url+"\n"))}},(e=t).fetch=async function(t,a){if("string"==typeof t){if(t.endsWith("m3u8")&&t.includes("ttvnw.net")&&!e.whitelist.includes(e.actualChannel))return new Promise((function(r,i){!async function(t){try{await e.realFetch(t,a).then((function(a){a.text().then((function(a){e.onFetch(e,a,t).then((function(t){var e=n.g.currentChannel().hls.getAllPlaylist();r(new Response(e))}))}))}))}catch(t){r(new Response)}}(t)}));if(t.includes("usher.ttvnw.net/api/channel/hls/")&&!t.includes("picture-by-picture"))return new Promise((function(n,r){!async function(t){await e.realFetch(t,a).then((function(a){a.ok?a.text().then((async function(a){await e.onStartChannel(e,t,a),n(new Response(a))})):(n(a),e.LogPrint("channel offline"))}))}(t)}));t.includes("picture-by-picture")}return e.realFetch.apply(this,arguments)}})();