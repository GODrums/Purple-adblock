// ==UserScript==
// @name         Purple Adblocker
// @namespace    https://github.com/arthurbolsoni
// @version      2.3.5
// @description  Per aspera ad astra
// @author       ArthurBolzoni
// @match        https://raw.githubusercontent.com/arthurbolsoni/Purple-adblock/main/chrome/app/bundle.js
// @icon         https://www.google.com/s2/favicons?sz=64&domain=githubusercontent.com
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @grant        none
// ==/UserScript==

(()=>{"use strict";!function(){let t;window.postMessage({type:"init"}),window.Worker=class extends Worker{constructor(e){console.log("new worker intance "+e),""==e&&super(e),console.log("[Purple]: init "+e);const s=`(()=>{"use strict";var t={};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}();class e{constructor(){this._header=["#EXTM3U","#EXT-X-VERSION:3","#EXT-X-TARGETDURATION:6","#EXT-X-MEDIA-SEQUENCE:"],this._playlist=[],this._sequence=0}addPlaylistTest(t){}addPlaylist(t,e=!1){if(null===t)return!1;let n=!1;const s=t.toString().split(/[\\r\\n]/);this._header[4]=s[4],this._header[5]=s[5];for(const t in s)if(s[t].includes("#EXTINF")){if(!e&&!s[t].includes(",live"))continue;const i=Math.floor(new Date(s[parseInt(t)-1].slice(s[parseInt(t)-1].length-24,s[parseInt(t)-1].length)).getTime()/1e3);for(this._playlist.filter((t=>t.timestamp>=i)).length||(this._sequence=this._sequence+1,this._playlist.push({time:s[parseInt(t)-1],timestamp:i,info:s[parseInt(t)],url:s[parseInt(t)+1]}),n=!0);this._playlist.length>15;)this._playlist.shift()}return n}getPlaylist(){return this._header[0]+"\\n"+this._header[1]+"\\n"+this._header[2]+"\\n"+this._header[3]+this._sequence+"\\n"+this._header[4]+"\\n"+this._header[5]+"\\n"+this._playlist.map((t=>t.time+"\\n"+t.info+"\\n"+t.url+"\\n"))}}const n={playerType:"thunderdome",name:"lower"},s={playerType:"site",name:"normal"},i={name:"external"};class r{constructor(t){this.bestQuality=()=>this.urlList[0],this.findByQuality=t=>this.urlList.find((e=>e.quality==t)),Object.assign(this,t)}}var a=function(t,e,n,s){return new(n||(n=Promise))((function(i,r){function a(t){try{h(s.next(t))}catch(t){r(t)}}function l(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,l)}h((s=s.apply(t,e||[])).next())}))};class l{constructor(t,n=""){this.serverList=[],this.hls=new e,this.channelName="",this.tunnel=["https://eu1.jupter.ga/channel/{channelname}","https://eu2.jupter.ga/channel/{channelname}"],this.currentTunnel=this.tunnel[0],this.tryExternalPlayer=()=>a(this,void 0,void 0,(function*(){(yield this.streamAccess(i))||this.externalPlayer(!0)})),this.channelName=t,n&&(this.currentTunnel=n)}addStreamLink(t,e="local",n=!0){return a(this,void 0,void 0,(function*(){const s=[];let i;const a=/NAME="((?:\\S+\\s+\\S+|\\S+))",AUTO(?:^|\\S+\\s+)(?:^|\\S+\\s+)(https:\\/\\/video(\\S+).m3u8)/g;for(;null!==(i=a.exec(t));)s.push({quality:i[1],url:i[2]});const l=new r({type:e,urlList:s,sig:n});return this.serverList.push(l),n||(yield this.signature()),!0}))}signature(){return a(this,void 0,void 0,(function*(){const t=/video-weaver.(.*).hls.ttvnw.net\\/v1\\/playlist\\/(.*).m3u8$/gm;yield new Promise((e=>this.serverList.filter((t=>0==t.sig)).forEach((n=>a(this,void 0,void 0,(function*(){const s=t.exec(n.urlList[0].url);if(s)try{yield fetch("https://jupter.ga/hls/v2/sig/"+s[2]+"/"+s[1]),n.sig=!0,e(!0)}catch(t){e(!1)}else e(!1)}))))))}))}externalPlayer(e=!1){return a(this,void 0,void 0,(function*(){e&&(this.currentTunnel=this.tunnel[0]);try{t.g.LogPrint("External Server: Loading");const e=yield t.g.realFetch(this.currentTunnel.replace("{channelname}",this.channelName));if(!e.ok)throw new Error("server proxy return error or not found");const n=yield e.text();return t.g.LogPrint("External Server: OK"),this.addStreamLink(n,i.name),!0}catch(e){return t.g.LogPrint("server proxy return error or not found "+this.currentTunnel),t.g.LogPrint(e),!1}}))}streamAccess(e){return a(this,void 0,void 0,(function*(){if(e.name==i.name)return yield this.externalPlayer();try{const n=yield t.g.realFetch("https://gql.twitch.tv/gql",{method:"POST",headers:{"Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko"},body:\`{"operationName":"PlaybackAccessToken","variables":{"isLive":true,"login":"\${this.channelName}","isVod":false,"vodID":"","playerType":"\${e.playerType}"},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"0828119ded1c13477966434e15800ff57ddacf13ba1911c129dc2200705b0712"}}}\`}),s=yield n.json(),i="https://usher.ttvnw.net/api/channel/hls/"+this.channelName+".m3u8?allow_source=true&fast_bread=true&p="+Math.floor(1e7*Math.random())+"&player_backend=mediaplayer&playlist_include_framerate=true&reassignments_supported=false&sig="+s.data.streamPlaybackAccessToken.signature+"&supported_codecs=avc1&token="+s.data.streamPlaybackAccessToken.value,r=yield(yield t.g.realFetch(i)).text();return t.g.LogPrint("Server loaded "+e.name),this.addStreamLink(r,e.name),!0}catch(t){return console.log(t),!1}}))}}class h{constructor(){this.getQuality=()=>t.g.postMessage({type:"getQuality"}),this.init=()=>t.g.postMessage({type:"init"}),this.pause=()=>t.g.postMessage({type:"pause"}),this.play=()=>t.g.postMessage({type:"play"}),this.pauseAndPlay=()=>{this.pause(),this.play()},this.quality="",t.g.onEventMessage=t=>{switch(t.data.funcName){case"pause":case"play":case"Ready":case"Playing":default:break;case"setQuality":t.data.args&&(this.quality=t.data.args[0].name),t.data.value&&(this.quality=t.data.value);break;case"setSetting":this.setting=t.data.value}}}}var o=function(t,e,n,s){return new(n||(n=Promise))((function(i,r){function a(t){try{h(s.next(t))}catch(t){r(t)}}function l(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,l)}h((s=s.apply(t,e||[])).next())}))};class c{constructor(){this.streamList=[],this.actualChannel="",this.playingAds=!1,this.quality="",this.LogPrint=t.g.LogPrint,this.message=new h,this.playerChangeHLS=()=>this.message.pauseAndPlay(),this.isAds=t=>{const e=t.toString().includes("stitched-ad")||t.toString().includes("twitch-client-ad")||t.toString().includes("twitch-ad-quartile");return this.playingAds=e,this.playingAds},this.currentStream=(t=this.actualChannel)=>this.streamList.find((e=>e.channelName===t)),this.message.init()}onfetch(t,e){return o(this,void 0,void 0,(function*(){const t=yield this.currentStream();if(t.hls.addPlaylist(e),!this.isAds(e))return!0;this.LogPrint("ads found"),this.currentStream().streamAccess(s);try{const e=yield this.fetchm3u8ByStreamType(s.name);if(e&&t.hls.addPlaylist(e),e)return!0;const r=yield this.fetchm3u8ByStreamType(n.name);if(r&&t.hls.addPlaylist(r),r)return!0;const a=yield this.fetchm3u8ByStreamType(i.name);return a&&t.hls.addPlaylist(a),a||t.hls.addPlaylist(r,!0),!0}catch(t){console.log(t.message)}}))}fetchm3u8ByStreamType(e){return o(this,void 0,void 0,(function*(){this.LogPrint("Stream Type: "+e);const n=this.currentStream().serverList.filter((t=>t.type==e));if(!n)return"";var s=n.map((t=>t.findByQuality(this.message.quality))).filter((t=>void 0!==t));s.length||(s=n.map((t=>t.bestQuality())));for(const e of s){const n=yield(yield t.g.realFetch(null==e?void 0:e.url)).text();if(!this.isAds(n))return n}return""}))}onStartChannel(t,e){return o(this,void 0,void 0,(function*(){const i=/hls\\/(.*).m3u8/gm.exec(t)||[];let r,a=!1,h=[];if(i[1]){if(null==!this.message.setting&&null==!this.message.setting.whitelist&&(h=this.message.setting.whitelist),this.actualChannel=i[1],this.LogPrint("Channel "+i[1]),h.includes(i[1]))return;if(this.streamList.find((t=>t.channelName===i[1])))this.LogPrint("Exist: "+i[1]),a=!0;else{let t="";this.message.setting&&(t=this.message.setting.proxyUrl?this.message.setting.proxyUrl:""),this.streamList.push(new l(i[1],t))}}r=this.currentStream(),this.LogPrint("Local Server: Loading"),yield r.addStreamLink(e,"local",!1),this.LogPrint("Local Server: OK"),r.streamAccess(s),r.streamAccess(n),a||r.tryExternalPlayer()}))}inflateFetch(){t.g.fetch=function(e,n){return o(this,arguments,void 0,(function*(){if("string"==typeof e){if(e.endsWith("m3u8")&&e.includes("ttvnw.net"))return new Promise(((s,i)=>o(this,void 0,void 0,(function*(){try{yield t.g.realFetch(e,n).then((t=>o(this,void 0,void 0,(function*(){return t.text()})))).then((n=>o(this,void 0,void 0,(function*(){yield t.g.player.onfetch(e,n);var i=t.g.player.currentStream().hls.getPlaylist();s(new Response(i))}))))}catch(t){s(new Response)}}))));if(e.includes("usher.ttvnw.net/api/channel/hls/")&&!e.includes("picture-by-picture"))return new Promise(((s,i)=>o(this,void 0,void 0,(function*(){try{const i=yield t.g.realFetch(e,n);i.ok||s(i),i.text().then((n=>o(this,void 0,void 0,(function*(){yield t.g.player.onStartChannel(e,n),s(new Response(n))}))))}catch(t){s(new Response)}}))));if(e.includes("picture-by-picture"))return this.LogPrint("picture-by-picture"),new Response}return t.g.realFetch.apply(this,arguments)}))}}}!function(){t.g.LogPrint=t=>console.log("[Purple]: ",t),t.g.addEventListener("message",(e=>{t.g.onEventMessage(e)}));const e=new c;t.g.realFetch=t.g.fetch,t.g.player=e,e.inflateFetch(),t.g.LogPrint("Script running")}()})();\n      importScripts('${e}');`;super(URL.createObjectURL(new Blob([s],{type:"text/javascript"}))),t=this,t.declareEventWorker(),t.declareEventWindow()}declareEventWorker(){this.addEventListener("message",(e=>{switch(e.data.type){case"init":window.postMessage({type:"getSetting",value:null});break;case"PlayerQualityChanged":t.postMessage({funcName:"setQuality",value:e.data.arg.name});break;case"pause":t.postMessage({funcName:"pause",args:void 0,id:1});break;case"play":t.postMessage({funcName:"play",args:void 0,id:1})}if(e.data.arg){switch(e.data.arg.key){case"quality":console.log("Changed quality by player: "+e.data.arg.value.name),t.postMessage({funcName:"setQuality",value:e.data.arg.value.name});break;case"state":t.postMessage({funcName:e.data.arg.value})}e.data.arg.name}}))}declareEventWindow(){window.addEventListener("message",(e=>{"setSetting"===e.data.type&&t.postMessage({funcName:"setSetting",value:e.data.value})}))}}}()})();