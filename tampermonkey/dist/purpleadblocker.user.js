// ==UserScript==
// @name         Purple Adblocker
// @source       https://github.com/arthurbolsoni/Purple-adblock
// @version      2.5.0.9
// @description  Per aspera ad astra
// @author       ArthurBolzoni
// @downloadURL  https://raw.githubusercontent.com/arthurbolsoni/Purple-adblock/main/tampermonkey/dist/purpleadblocker.user.js
// @updateURL    https://raw.githubusercontent.com/arthurbolsoni/Purple-adblock/main/tampermonkey/dist/purpleadblocker.user.js
// @match        *://*.twitch.tv/*
// @run-at       document-start
// @grant        none
// ==/UserScript==

(()=>{"use strict";var e={114:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(n(597));!function(){let e;window.Worker=class extends Worker{constructor(t){console.log("new worker intance "+t),""==t&&super(t),console.log("[Purple]: init "+t);const n=`${s.default}\n      importScripts('${t}');`;super(URL.createObjectURL(new Blob([n],{type:"text/javascript"}))),e=this,e.declareEventWorker(),e.declareEventWindow()}declareEventWorker(){this.addEventListener("message",(t=>{switch(t.data.type){case"getSettings":window.postMessage({type:"getSettings",value:null});break;case"PlayerQualityChanged":e.postMessage({funcName:"setQuality",value:t.data.arg.name});break;case"pause":e.postMessage({funcName:"pause",args:void 0,id:1});break;case"play":e.postMessage({funcName:"play",args:void 0,id:1})}if(t.data.arg){switch(t.data.arg.key){case"quality":if(!t.data.arg.value.name)break;console.log("Changed quality by player: "+t.data.arg.value.name),e.postMessage({funcName:"setQuality",value:t.data.arg.value.name});break;case"state":e.postMessage({funcName:t.data.arg.value})}t.data.arg.name}}))}declareEventWindow(){window.addEventListener("message",(t=>{"setSettings"===t.data.type&&e.postMessage({funcName:"setSettings",value:t.data.value})}))}}}()},597:e=>{e.exports='(()=>{"use strict";var e={799:function(e,t,n){var r=this&&this.__decorate||function(e,t,n,r){var i,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,n,a):i(t,n))||a);return s>3&&a&&Object.defineProperty(t,n,a),a},i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.appController=void 0;const s=n(289),a=n(35);let o=class{constructor(e){this.appService=e,this.getQuality=()=>n.g.postMessage({type:"getQuality"}),this.getSettings=()=>n.g.postMessage({type:"getSettings"}),this.pause=()=>n.g.postMessage({type:"pause"}),this.play=()=>n.g.postMessage({type:"play"}),this.pauseAndPlay=()=>{this.pause(),this.play()},this.getSettings()}onChannel(e,t){return i(this,void 0,void 0,(function*(){const r=yield n.g.realFetch(e,t);return r.ok?yield r.text().then((t=>i(this,void 0,void 0,(function*(){return yield this.appService.onStartChannel(e,t),new Response(t)})))):r}))}onFetch(e,t){return i(this,void 0,void 0,(function*(){return yield realFetch(e,t).then((e=>i(this,void 0,void 0,(function*(){return e.text()})))).then((t=>i(this,void 0,void 0,(function*(){yield this.appService.onfetch(e,t);const n=this.appService.currentStream().hls.getPlaylist();return new Response(n)}))))}))}onChannelPicture(e,t){return i(this,void 0,void 0,(function*(){return new Response}))}setSettings(e){return i(this,void 0,void 0,(function*(){this.appService.settings=e.value}))}setQuality(e){return i(this,void 0,void 0,(function*(){this.appService.quality=e.value}))}};r([(0,a.Fetch)("usher.ttvnw.net/api/channel/hls/","picture-by-picture")],o.prototype,"onChannel",null),r([(0,a.Fetch)("hls.ttvnw.net/v1/playlist/")],o.prototype,"onFetch",null),r([(0,a.Fetch)("picture-by-picture")],o.prototype,"onChannelPicture",null),r([(0,a.Message)("setSettings")],o.prototype,"setSettings",null),r([(0,a.Message)("setQuality")],o.prototype,"setQuality",null),o=r([(0,s.Controller)()],o),t.appController=o},37:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(799),s=n(651);function a(){n.g.LogPrint=e=>console.log("[Purple]: ",e),n.g.appController=new i.appController(new s.Player),n.g.LogPrint("Script running")}t.default=a,n.g.realFetch=n.g.fetch,n.g.fetch=(e,t)=>r(void 0,void 0,void 0,(function*(){if("string"==typeof e)for(var i=0,s=routerList.length;i<s;i++)if(e.includes(routerList[i].match)&&!e.includes(routerList[i].ignore))return new Promise(((s,a)=>r(void 0,void 0,void 0,(function*(){return s(yield n.g.appController[routerList[i].propertyKey](e,t))}))));return n.g.realFetch.apply(this,[e,t])})),n.g.addEventListener("message",(e=>{n.g.messageList.forEach((t=>{e.data.funcName==t.match&&n.g.appController[t.propertyKey](e.data)}))})),a()},289:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Controller=void 0,t.Controller=()=>e=>{}},35:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Message=t.Fetch=void 0,t.Fetch=(e,t=null)=>(r,i)=>{n.g.routerList||(n.g.routerList=[]),n.g.routerList.push({propertyKey:i,match:e,ignore:t})},t.Message=e=>(t,r)=>{n.g.messageList||(n.g.messageList=[]),n.g.messageList.push({propertyKey:r,match:e})}},813:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.HLS=void 0,t.HLS=class{constructor(){this._header=["#EXTM3U","#EXT-X-VERSION:3","#EXT-X-TARGETDURATION:6","#EXT-X-MEDIA-SEQUENCE:"],this._playlist=[],this._sequence=0}addPlaylistTest(e){}addPlaylist(e,t=!1){if(null===e)return!1;let n=!1;const r=e.toString().split(/[\\r\\n]/);this._header[4]=r[4],this._header[5]=r[5];for(const e in r)if(r[e].includes("#EXTINF")){if(!t&&!r[e].includes(",live"))continue;const i=Math.floor(new Date(r[parseInt(e)-1].slice(r[parseInt(e)-1].length-24,r[parseInt(e)-1].length)).getTime()/1e3);for(this._playlist.filter((e=>e.timestamp>=i)).length||(this._sequence=this._sequence+1,this._playlist.push({time:r[parseInt(e)-1],timestamp:i,info:r[parseInt(e)],url:r[parseInt(e)+1]}),n=!0);this._playlist.length>15;)this._playlist.shift()}return n}getPlaylist(){let e="";return this._playlist.forEach((t=>e=e+t.time+"\\n"+t.info+"\\n"+t.url+"\\n")),this._header[0]+"\\n"+this._header[1]+"\\n"+this._header[2]+"\\n"+this._header[3]+this._sequence+"\\n"+this._header[4]+"\\n"+this._header[5]+"\\n"+e}}},651:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Player=void 0;const i=n(770),s=n(118);t.Player=class{constructor(){this.streamList=[],this.actualChannel="",this.playingAds=!1,this.settings={whitelist:[],toggleProxy:!1,proxyUrl:"",toggleDNS:!1},this.quality="",this.onStartAds=()=>{},this.onEndAds=()=>{},this.isAds=(e,t=!1)=>{const n=e.toString().includes("stitched");return t?(this.playingAds!=n&&n&&this.onStartAds(),this.playingAds==n||n||this.onEndAds(),this.playingAds=n,this.playingAds):n},this.currentStream=(e=this.actualChannel)=>this.streamList.find((t=>t.channelName===e))}isWhitelist(){return!!this.settings.whitelist&&!(!this.settings.whitelist.includes(this.actualChannel)||null!=this.currentStream())}onfetch(e,t){return r(this,void 0,void 0,(function*(){const e=yield this.currentStream();if(e.hls.addPlaylist(t),this.isWhitelist())return!0;if(!this.isAds(t,!0))return!0;try{const t=yield this.fetchm3u8ByStreamType(s.streams.local);if(t&&e.hls.addPlaylist(t),t||e.streamAccess(s.streams.local),t)return!0;const n=yield this.fetchm3u8ByStreamType(s.streams.external);return n&&e.hls.addPlaylist(n),!!n||(console.log("fail"),!1)}catch(e){console.log(e.message)}}))}fetchm3u8ByStreamType(e){return r(this,void 0,void 0,(function*(){LogPrint("Stream Type: "+e.name);const t=this.currentStream().getStreamServersByStreamType(e,this.quality);for(const e of t){const t=yield(yield n.g.realFetch(null==e?void 0:e.url)).text();if(!this.isAds(t))return t}return""}))}onStartChannel(e,t){return r(this,void 0,void 0,(function*(){const t=/hls\\/(.*).m3u8/gm.exec(e)||[];LogPrint("Channel "+t[1]),this.actualChannel=t[1],this.streamList.push(new i.Stream(this.actualChannel,this.settings.proxyUrl||""));const n=this.currentStream();return!(this.settings.whitelist&&this.settings.whitelist.includes(this.actualChannel)||(n.streamAccess(s.streams.local),this.settings.toggleProxy&&n.streamAccess(s.streams.external),0))}))}}},118:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.streams=void 0,t.streams={picture:{playerType:"thunderdome",name:"lower"},local:{playerType:"embed",name:"normal"},external:{name:"external"},dns:{name:"dns"}}},777:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.streamServer=t.qualityUrl=void 0,t.qualityUrl=class{constructor(){this.url="",this.quality=""}},t.streamServer=class{constructor(e){this.bestQuality=()=>this.urlList[0],this.findByQuality=e=>this.urlList.find((t=>t.quality==e)),Object.assign(this,e)}}},770:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Stream=void 0;const i=n(813),s=n(118),a=n(777);t.Stream=class{constructor(e,t){this.serverList=[],this.hls=new i.HLS,this.channelName="",this.tunnel=["https://eu1.jupter.ga/channel/{channelname}","https://eu2.jupter.ga/channel/{channelname}"],this.currentTunnel=this.tunnel[0],this.channelName=e,t&&(this.currentTunnel=t)}addStreamLink(e,t="local",n=!0){return r(this,void 0,void 0,(function*(){const r=[];let i;const s=/NAME="((?:\\S+\\s+\\S+|\\S+))",AUTO(?:^|\\S+\\s+)(?:^|\\S+\\s+)(https:\\/\\/video(\\S+).m3u8)/g;for(;null!==(i=s.exec(e));)r.push({quality:i[1],url:i[2]});const o=new a.streamServer({type:t,urlList:r,sig:n});return this.serverList.push(o),!0}))}signature(){return r(this,void 0,void 0,(function*(){const e=/video-weaver.(.*).hls.ttvnw.net\\/v1\\/playlist\\/(.*).m3u8$/gm;yield new Promise((t=>{this.serverList.filter((e=>0==e.sig)).forEach((n=>r(this,void 0,void 0,(function*(){const r=e.exec(n.urlList[0].url);if(r)try{yield fetch("https://jupter.ga/hls/v2/sig/"+r[2]+"/"+r[1]),n.sig=!0,t(!0)}catch(e){t(!1)}else t(!1)})))),t(!1)}))}))}externalRequest(e=!1){return r(this,void 0,void 0,(function*(){e&&(this.currentTunnel=this.tunnel[0]);try{n.g.LogPrint("External Server: Loading");const e=yield n.g.realFetch(this.currentTunnel.replace("{channelname}",this.channelName));if(!e.ok)throw new Error("server proxy return error or not found");const t=yield e.text();return n.g.LogPrint("External Server: OK"),this.addStreamLink(t,s.streams.external.name),!0}catch(e){return n.g.LogPrint("server proxy return error or not found "+this.currentTunnel),n.g.LogPrint(e),!1}}))}streamAccess(e){return r(this,void 0,void 0,(function*(){if(e.name==s.streams.external.name)return this.externalRequest()||this.externalRequest(!0),!1;try{const t={operationName:"PlaybackAccessToken_Template",query:\'query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "web", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature    __typename  }  videoPlaybackAccessToken(id: $vodID, params: {platform: "web", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature    __typename  }}\',variables:{isLive:!0,login:this.channelName,isVod:!1,vodID:"",playerType:e.playerType}},r=yield n.g.realFetch("https://gql.twitch.tv/gql",{method:"POST",headers:{Host:"gql.twitch.tv","Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko"},body:JSON.stringify(t)}),i=yield r.json(),s="https://usher.ttvnw.net/api/channel/hls/"+this.channelName+".m3u8?allow_source=true&fast_bread=true&p="+Math.floor(1e7*Math.random())+"&player_backend=mediaplayer&playlist_include_framerate=true&reassignments_supported=false&sig="+i.data.streamPlaybackAccessToken.signature+"&supported_codecs=avc1&token="+i.data.streamPlaybackAccessToken.value,a=yield(yield n.g.realFetch(s)).text();return n.g.LogPrint("Server loaded "+e.name),this.addStreamLink(a,e.name),!0}catch(e){return console.log(e),!1}}))}getStreamServersByStreamType(e,t){const n=this.serverList.filter((t=>t.type==e.name));if(!n)return[];const r=n.map((e=>e.findByQuality(t))).filter((e=>void 0!==e));return r.length?r:n.map((e=>e.bestQuality()))}}}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,n),s.exports}n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n(37)})();'}},t={};!function n(r){var s=t[r];if(void 0!==s)return s.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(114)})();